# Arduinoを用いた肺活量測定器兼電子オカリナ

このシステムは、Arduino AT-mega32を用いた、小学生を対象とした肺活量測定器兼電子オカリナです。

これは、八戸高専本科4年生の時に創成実験という科目内で制作しました。

気圧センサBME680を用いて楽器に吹き込んでいる時の気圧を測定し、どの程度の肺活量かをLogに表示します。

また、オカリナの運指に合わせたボタンを押す + 測定した気圧の変化　により音を出し、演奏することができます。

小学生を対象としているため、肺活量の指標はわかりやすく伝えています。

3人共同で行いましたが、私はハードウェアの設計と気圧測定+音を出すプログラムの開発を行いました。


## ハードウェアについて

## Arduinoマイコンの配線

![Sizzling Krunk-Turing](https://github.com/Take-Kai/Arduino-Okarina/assets/169955027/79b46721-4358-486c-ad6b-23472910ab36)

Arduinoの配線図は上記のようになっています。

Arduinoにはプッシュボタン、スピーカー、気圧センサBME680が接続されています。

この気圧センサBME680は、気圧の他に温度と湿度も測定することができます。

プッシュボタンは5〜8番ピン,10〜13番ピンに、スピーカーは9番ピンに、BME680はブレットボードと通信用ピンにそれぞれ接続されています。

また、プッシュボタンを接続する際にはプルアップ抵抗として10kΩの抵抗を介しています。


## オカリナの概形

![Okarina](https://github.com/Take-Kai/Arduino-Okarina/assets/169955027/6e89bbab-396d-465a-94f1-6beb8ce7e33e)

オカリナの概形は上の図のようになっています。

これは、共同研究者がFusion360にて制作したものです。

これを3Dプリンターで印刷し、中にArduinoが入るように半分に切断したものが下の画像です。

![Okarina_skelton](https://github.com/Take-Kai/Arduino-Okarina/assets/169955027/cf5b2a49-4668-4f9f-be5c-c0b0debabb78)


しかし、このオカリナではArduinoが完全に入らず、プッシュボタンをどのように配置するのかを考慮できていませんでした。

授業時間の関係でオカリナはここで終わってしまいましたが、改善の余地が多くあり、本物のオカリナのような概形でかつ気圧を測ることができるような設計にすることができると期待できます。




## ソフトウェア関係について

使用するArduinoマイコンに、ボタンを押して息を吹くと音が出るプログラムや、気圧を測定するプログラムを作成しました。

そのプログラムが、添付したbme680test_v4.inoです。


## プログラム内容

プログラムでは、まずプッシュボタンがどのピンに刺さっているのかを宣言しています。

次に、setup関数内ですが、ここではプッシュボタン用のピンが入力用に使われ、スピーカー用のピンが出力用に使われるということを設定しています。

また、この関数内でシリアル通信を開始し、気圧センサで気圧を測定する準備をします。

測定が可能になったら、最初の5つのデータを用いて気圧、温度、湿度の平均を算出し、表示します。

この平均値は、肺活量がどのくらいかの指標や音が出るまでの気圧値の指標として用います。

次に、loop関数についてです。loop関数ではまず、それぞれのピンから入力された値をデジタルリードで取得しています。

また、測定した圧力を常にLog表示しています。

次から、気圧の値によって肺活量を決めたり音を出す部分になります。

まずは、測定した気圧値 >= 平均値+0.04 かつ 測定した気圧 < 平均値+0.2の時に関してです。

測定した気圧がこの範囲内の値になったら肺活量は「いいね！」となり、所定のボタンを押すと音が出るようになります。

この時、出る音は周波数によって設定しています。例えば、「ド」なら252Hz、「ミ」なら329Hzのようになっています。

測定した値 >= 平均値+0.5 かつ 測定した湿度の値 > 湿度の平均値+2 となった時は「いいね！」の時よりもより多くの息を吹き込んだと判定し、「素晴らしい！」と表示しています。

また、「いいね！」となる気圧変化に満たなかった場合は「もっと吹いて！」と表示しています。

以上がプログラム内容です。

